---
title: "Explore pandora co-occur network"
author: "Gavin Douglas"
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    code_folding: hide
    theme: cerulean
    toc: true
    toc_float: true
---


```{r setup, include=FALSE}
library("reshape2")
library("ggnetwork")
library("igraph")
library(kableExtra)
library(knitr)
```

# Preprocess data

```{r read_in_data}
discover_output <- readRDS("/data1/gdouglas/projects/honey_bee/combined_Ellegaard.2019.2020/DISCOVER_network/Ellegaard_2019_2020_DISCOVER_cooccur_results_clustered_DBH0.3.rds")

Bifidobacterium_path_to_panaroo <- "/data1/gdouglas/projects/honey_bee/panaroo_pangenomes/complete_raw_output/Bifidobacterium/gene_presence_absence_roary.csv.gz"

Bifidobacterium_panaroo_out <- read.table(Bifidobacterium_path_to_panaroo,
                                          header = TRUE, sep = ",", stringsAsFactors = FALSE, quote = "", comment.char = "", row.names = 1)
rownames(Bifidobacterium_panaroo_out) <- paste("Bifidobacterium", rownames(Bifidobacterium_panaroo_out), sep = "_")


Firm4_path_to_panaroo <- "/data1/gdouglas/projects/honey_bee/panaroo_pangenomes/complete_raw_output/Firm4//gene_presence_absence_roary.csv.gz"

Firm4_panaroo_out <- read.table(Firm4_path_to_panaroo,
                                header = TRUE, sep = ",", stringsAsFactors = FALSE, quote = "", comment.char = "", row.names = 1)
rownames(Firm4_panaroo_out) <- paste("Firm4", rownames(Firm4_panaroo_out), sep = "_")


Firm5_path_to_panaroo <- "/data1/gdouglas/projects/honey_bee/panaroo_pangenomes/complete_raw_output/Firm5//gene_presence_absence_roary.csv.gz"

Firm5_panaroo_out <- read.table(Firm5_path_to_panaroo,
                                header = TRUE, sep = ",", stringsAsFactors = FALSE, quote = "", comment.char = "", row.names = 1)
rownames(Firm5_panaroo_out) <- paste("Firm5", rownames(Firm5_panaroo_out), sep = "_")

Gilliamella_path_to_panaroo <- "/data1/gdouglas/projects/honey_bee/panaroo_pangenomes/roary_formatted_files/Gilliamella_gene_presence_absence_roary-formatted.csv.gz"
Gilliamella_panaroo_out <- read.table(Gilliamella_path_to_panaroo,
                                      header = TRUE, sep = ",", stringsAsFactors = FALSE, quote = "", comment.char = "", row.names = 1)
rownames(Gilliamella_panaroo_out) <- paste("Gilli", rownames(Gilliamella_panaroo_out), sep = "_")

Snodgrassella_path_to_panaroo <- "/data1/gdouglas/projects/honey_bee/panaroo_pangenomes/roary_formatted_files/Snodgrassella_gene_presence_absence_roary-formatted.csv.gz"
Snodgrassella_panaroo_out <- read.table(Snodgrassella_path_to_panaroo,
                                        header = TRUE, sep = ",", stringsAsFactors = FALSE, quote = "", comment.char = "", row.names = 1)
rownames(Snodgrassella_panaroo_out) <- paste("Snod", rownames(Snodgrassella_panaroo_out), sep = "_")

panaroo_out <- rbind(Bifidobacterium_panaroo_out[, c(1:13)],
                     Firm4_panaroo_out[, c(1:13)],
                     Firm5_panaroo_out[, c(1:13)],
                     Gilliamella_panaroo_out[, c(1:13)],
                     Snodgrassella_panaroo_out[, c(1:13)])
num_samples <- 71
```

```{r prep_full_network}
discover_output_edges <- discover_output[, c("gene1", "gene2")]
colnames(discover_output_edges) <- c("from", "to")

all_unique_nodes <- c(discover_output_edges$from, discover_output_edges$to) 
all_unique_nodes <- all_unique_nodes[-which(duplicated(all_unique_nodes))]

nodes_info <- data.frame(id = all_unique_nodes,
                         annot = panaroo_out[all_unique_nodes, "Annotation"])

nodes_info$genus <- NA
nodes_info[grep("Bifidobacterium", nodes_info$id), "genus"] <- "Bifidobacterium"
nodes_info[grep("Firm4", nodes_info$id), "genus"] <- "Firm4"
nodes_info[grep("Firm5", nodes_info$id), "genus"] <- "Firm5"
nodes_info[grep("Gilli", nodes_info$id), "genus"] <- "Gilliamella"
nodes_info[grep("Snod", nodes_info$id), "genus"] <- "Snodgrassella"

net <- graph_from_data_frame(d = discover_output_edges,
                             vertices = nodes_info,
                             directed = FALSE)
```

# Total associations and genes

```{r num_total_genes}
total_genes <- c(discover_output$gene1, discover_output$gene2)
total_genes <- total_genes[-which(duplicated(total_genes))]
```
There are `r nrow(discover_output)` associations (at q < 0.3) in total based on `r length(total_genes)` unique genes.

# Centrality metrics {.tabset}

Only looked at edge degrees and betweenness centrality, because others I looked at were redundant or made no sense for unconnected graphs.

```{r compute_centrality_metrics}
net_degree <- degree(net)
net_betweenness <- betweenness(net)

```

## Edge degree
```{r degree_histogram}
hist(net_degree)
```

Top 10 nodes by degree:
```{r degree_top10}
head(panaroo_out[names(sort(net_degree, decreasing = TRUE)), "Annotation"], 10)
```

## Betweenness centrality
```{r betweenness_histogram}
hist(net_betweenness)
```

Top 10 nodes by betweenness:
```{r betweenness_top10}
head(panaroo_out[names(sort(net_betweenness, decreasing = TRUE)), "Annotation"], 10)
```


# Network graph
With all associations at discrete BH (DBH) < 0.3.

```{r save_components}
net_components <- components(net)

saveRDS(object = net_components,
        file = "/data1/gdouglas/projects/honey_bee/combined_Ellegaard.2019.2020/DISCOVER_network/Ellegaard_2019_2020_DISCOVER_cooccur_results_clustered_DBH0.3_components.rds")
```

```{r full_graph}
net_flattened <- ggnetwork(net)

ggplot(net_flattened, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges() +
  geom_nodes(aes(color = genus), size = 3) +
  theme_blank()
```

# Network graph (for nodes with DBH < 0.05)
```{r stringent_graph}
discover_output_edges_0.05 <- discover_output[which(discover_output$q.value < 0.05), c("gene1", "gene2")]
colnames(discover_output_edges_0.05) <- c("from", "to")

all_unique_nodes_0.05 <- c(discover_output_edges_0.05$from, discover_output_edges_0.05$to) 
all_unique_nodes_0.05 <- all_unique_nodes_0.05[-which(duplicated(all_unique_nodes_0.05))]

nodes_info_0.05 <- data.frame(id = all_unique_nodes_0.05,
                             annot = panaroo_out[all_unique_nodes_0.05, "Annotation"])

nodes_info_0.05$genus <- NA
nodes_info_0.05[grep("Bifidobacterium", nodes_info_0.05$id), "genus"] <- "Bifidobacterium"
nodes_info_0.05[grep("Firm4", nodes_info_0.05$id), "genus"] <- "Firm4"
nodes_info_0.05[grep("Firm5", nodes_info_0.05$id), "genus"] <- "Firm5"
nodes_info_0.05[grep("Gilli", nodes_info_0.05$id), "genus"] <- "Gilliamella"
nodes_info_0.05[grep("Snod", nodes_info_0.05$id), "genus"] <- "Snodgrassella"

net_0.05 <- graph_from_data_frame(d = discover_output_edges_0.05,
                                 vertices = nodes_info_0.05,
                                 directed = FALSE)
net_flattened_0.05 <- ggnetwork(net_0.05)

ggplot(net_flattened_0.05, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges() +
  geom_nodes(aes(color = genus), size = 3) +
  theme_blank()
```

# Cross-phylotype associations

```{r crossphylotype_tally}
discover_output$phylotype1 <- gsub("_.*", "",discover_output$gene1)
discover_output$phylotype2 <- gsub("_.*", "",discover_output$gene2)

discover_output_cross <- discover_output[which(discover_output$phylotype1 != discover_output$phylotype2), ]

total_cross_genes <- c(discover_output_cross$gene1, discover_output_cross$gene2)
total_cross_genes <- total_cross_genes[-which(duplicated(total_cross_genes))]

cross_gene_annot <- panaroo_out[total_cross_genes, "Annotation"]
cross_gene_annot_defined <- cross_gene_annot[-which(cross_gene_annot == "hypothetical protein")]

discover_output_cross$annot1 <- panaroo_out[discover_output_cross$gene1, "Annotation"]
discover_output_cross$annot2 <- panaroo_out[discover_output_cross$gene2, "Annotation"]

discover_output_cross_defined <- discover_output_cross[-which(discover_output_cross$annot1 == "hypothetical protein"), ]
discover_output_cross_defined <- discover_output_cross_defined[-which(discover_output_cross_defined$annot2 == "hypothetical protein"), ]

write.table(x = discover_output_cross_defined,
            file = "/data1/gdouglas/projects/honey_bee/combined_Ellegaard.2019.2020/DISCOVER_network/Ellegaard_2019_2020_DISCOVER_cooccur_results_clustered_DBH0.3_cross_phylotype_defined.tsv",
            sep = "\t",
            quote = FALSE,
            col.names = TRUE,
            row.names = FALSE)
```

There are `r nrow(discover_output_cross)` cross-phylotype associations (at q < 0.3) in total based on `r length(total_cross_genes)` unique genes.


## Breakdown of cross-phylotype associations

```{r crossphylo_tally_breakdown}
cross_phylotype_instances <- c()

for (i in 1:nrow(discover_output_cross)) {
  phylotypes <- sort(c(discover_output_cross$phylotype1[i], discover_output_cross$phylotype2[i]))
  cross_phylotype_instances <- c(cross_phylotype_instances, paste(phylotypes, collapse = "_"))
}

tested_genes <- readRDS("/data1/gdouglas/projects/honey_bee/combined_Ellegaard.2019.2020/DISCOVER_network/Ellegaard_2019_2020_DISCOVER_tested_genes.rds")
tested_genes <- names(tested_genes[which(tested_genes)])

network_genes_only <- total_genes

compute_unnorm_expected_prop <- function(tested_genes, phylotype1, phylotype2) {

    phylotype1_prop <- length(grep(phylotype1, tested_genes)) / length(tested_genes)
    phylotype2_prop <- length(grep(phylotype2, tested_genes)) / length(tested_genes)
  
    return(phylotype1_prop * phylotype2_prop)
}

crossphylo_summary <- data.frame(matrix(NA, nrow = 10, ncol = 4))
colnames(crossphylo_summary) <- c("phylo_group", "observed", "unnorm_expected_prop", "unnorm_expected_prop_sig_genes")

phylotypes <- c("Bifidobacterium", "Firm4", "Firm5", "Gilli", "Snod")

row_i <- 1

for (p1 in phylotypes) {
 
  other_phylotypes <- phylotypes[-c(1:which(phylotypes == p1))]
  
  if (length(other_phylotypes) == 0) { break }
  
  for (p2 in other_phylotypes) {
   
    crossphylo_summary[row_i, "phylo_group"] <- paste(c(p1, p2), collapse = " - ")
    
    crossphylo_summary[row_i, "observed"] <- length(which(cross_phylotype_instances == paste(c(p1, p2), collapse = "_")))

    crossphylo_summary[row_i, "unnorm_expected_prop_all_genes"] <- compute_unnorm_expected_prop(tested_genes = tested_genes,
                                                                                                phylotype1 = p1,
                                                                                                phylotype2 = p2)

    crossphylo_summary[row_i, "unnorm_expected_prop_sig_genes"] <- compute_unnorm_expected_prop(tested_genes = network_genes_only,
                                                                                                phylotype1 = p1,
                                                                                                phylotype2 = p2)
    
    row_i <- row_i + 1          
  }
}

crossphylo_summary$expected_all_prop <- crossphylo_summary$unnorm_expected_prop_all_genes / sum(crossphylo_summary$unnorm_expected_prop_all_genes)
crossphylo_summary$expected_all_genes <- crossphylo_summary$expected_all_prop * nrow(discover_output_cross)

crossphylo_summary$expected_sig_prop <- crossphylo_summary$unnorm_expected_prop_sig_genes / sum(crossphylo_summary$unnorm_expected_prop_sig_genes)
crossphylo_summary$expected_sig_genes <- crossphylo_summary$expected_sig_prop * nrow(discover_output_cross)

crossphylo_summary_melt <- melt(crossphylo_summary[, c("phylo_group", "observed", "expected_all_genes", "expected_sig_genes")], id = "phylo_group", variable.name = "count_type")

ggplot(data = crossphylo_summary_melt, aes(y = phylo_group, x = value, colour = count_type)) +
  geom_point(size = 4) +
  xlab("Number of associations") +
  scale_y_discrete(limits = rev(levels(as.factor(crossphylo_summary_melt$phylo_group)))) +
  scale_colour_manual(values = c("green", "black", "brown"))
```

# Session info {.tabset}

## Hide

## Show

```{r session_info}
sessionInfo()
```
